name: test

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  create:
    tags:
      - '**'
  schedule:
    # Run every day at 8:42am UTC.
    - cron:  '42 8 * * *'

jobs:
  test_benchopt:
    name: Test
    runs-on: macos-latest
    env:
      CONDA_ENV: 'testcondaenv'
      JUNIT_XML: 'test-data.xml'
      COVERAGE: 0

    defaults:
      run:
        # Need to use this shell to get cond working properly.
        # See https://github.com/marketplace/actions/setup-miniconda#important
        shell: bash -l {0}

    steps:
      - uses: actions/checkout@v2
      - name: Setup Conda
        uses: conda-incubator/setup-miniconda@v2
        with:
          activate-environment: test_env
          python-version: 3.8
          # Use miniforge to only get conda-forge as default channel.
          miniforge-version: latest

      - run: conda info

      - name: Install benchopt and its dependencies
        run: |
          conda install -yq pip numpy scipy numba
          pip install scikit-learn
          ulimit -c unlimited && (python -c 'from sklearn.linear_model import Lasso' || (lldb -c `ls -t /cores/* | head -n1` \
                 --batch -o 'thread backtrace all' -o 'quit' && exit 1))
